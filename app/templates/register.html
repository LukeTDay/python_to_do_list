<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Todo App</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <h1>Register</h1>

    <div id="message"></div>

    <form id="registerform">
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username" required><br><br>

        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password" required><br><br>

        <label for="passwordconfirm">Confirm Password:</label><br>
        <input type="password" id="passwordconfirm" name="passwordconfirm" required><br><br>

        <button type="register_button" id="register_button">Register</button>
    </form>

        <button id="home_button">Back to Home</button>
        <button id="login_button">Already have an account?</button>
        <div id="notification_div"></div>

    <script>
        //Notification Div
        const notification_div = document.getElementById("notification_div");

        //Register Button
        const register_button = document.getElementById("register_button");
        const username_form = document.getElementById("username");
        const password_form = document.getElementById("password");
        const passwordconfirm_form = document.getElementById("passwordconfirm");
        //Expecting a UserCreate schema with the username and then the password    
        register_button.addEventListener("click", async(event) =>{
            event.preventDefault();
            //Must declare this in loop, if they are outside they will be None
            username = username_form.value;
            password = password_form.value;
            passwordconfirm = passwordconfirm_form.value;


            if (passwordconfirm !== password) {
                notification_div.style.visibility = "visible"
                notification_div.textContent = "Passwords must match eachother";
                notification_div.style.background = "grey";
                setTimeout(() => {notification_div.style.visibility = "hidden";}, 2000);
                return;

            }
            try {
                
                const response = await fetch(`/register`, {
                    method : "POST",
                    headers : { "Content-Type": "application/json"},
                    //Need to use JSON.Stringify because it manually sanitized password and usernames
                    // for things like quotes that would break a JSON if it was constructed manually
                    body: JSON.stringify({username,password})
                });

                if (response.status === 401) {
                    notification_div.style.visibility = "visible"
                    notification_div.textContent = "Error with registration";
                    notification_div.style.background = "grey";
                }
                else if (response.status === 422) {
                    notification_div.style.visibility = "visible"
                    notification_div.textContent = "Error with registration";
                    notification_div.style.background = "grey";
                }

                if (response.status === 200) {
                    const data = await response.json();
                    sessionStorage.setItem("username", data.username);
                    sessionStorage.setItem("token", data.access_token);
                    notification_div.style.visibility = "visible"
                    notification_div.textContent = "Welcome";
                    notification_div.style.background = "grey";
                    setTimeout(() => {window.location.href = "/login-page";}, 1000);
                }
            }
            catch (error){
                notification_div.style.visibility = "visible"
                notification_div.textContent = "Error";
                notification_div.style.background = "grey";
                setTimeout(() => {notification_div.style.visibility = "hidden";}, 2000);
            }
        })  


        //Login Button
        const login_button = document.getElementById("login_button");
        login_button.addEventListener("click", () => {
            notification_div.style.visibility = "visible"
            notification_div.textContent = "Redirecting to the login page"
            notification_div.style.background = "grey"
            setTimeout(() => {window.location.href = "/login-page";}, 1000);
        })

        //Home Button
        const home_button = document.getElementById("home_button");
        home_button.addEventListener("click", () => {
            notification_div.style.visibility = "visible"
            notification_div.textContent = "Redirecting to the home page"
            notification_div.style.background = "grey"
            setTimeout(() => {window.location.href = "/";}, 1000);
        })
    </script>
</body>