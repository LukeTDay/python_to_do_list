<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Todo App</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <h1>My Todo List</h1>

        <form id="todo-form" class="todo-form">
            <input type="text" id="todo-input" placeholder="Task title..." required>
            <input type="datetime-local" id="todo-due" required>
            <button type="submit">Add</button>
        </form>

        <table id="todo-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Title</th>
                    <th>Due</th>
                    <th>Done</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="todo-body"></tbody>
        </table>

        <div class="pagination">
            <button id="prev">&laquo; Prev</button>
            <span id="page-info">Page 1</span>
            <button id="next">Next &raquo;</button>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const limit = 5;

        function getToken() {
            return localStorage.getItem("token");
        }

        function handleUnauthorized() {
            localStorage.removeItem("token");
            localStorage.removeItem("username");
            alert("Your session has expired. Please log in again.");
            window.location.href = "/login-page";
        }

        async function fetchTodos(page = 1) {
            const token = getToken();
            if (!token) {
                window.location.href = "/login-page";
                return;
            }

            const skip = (page - 1) * limit;

            try {
                const response = await fetch(`/todos?skip=${skip}&limit=${limit}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                const todos = await response.json();
                renderTodos(todos);

            } catch (err) {
                console.error(err);
                alert("Failed to load todos.");
            }
        }

        function renderTodos(todos) {
            const tbody = document.getElementById("todo-body");
            tbody.innerHTML = "";

            todos.forEach(todo => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${todo.id}</td>
                    <td><input type="text" value="${todo.title}" id="title-${todo.id}"></td>
                    <td><input type="datetime-local" value="${new Date(todo.due_by).toISOString().slice(0,16)}" id="due-${todo.id}"></td>
                    <td><input type="checkbox" ${todo.completed ? "checked" : ""} id="completed-${todo.id}"></td>
                    <td>
                        <button onclick="updateTodo(${todo.id})">Update</button>
                        <button onclick="deleteTodo(${todo.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById("page-info").textContent = `Page ${currentPage}`;
        }

        async function deleteTodo(id) {
            const token = getToken();
            const response = await fetch(`/todos/delete`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ id })
            });

            if (response.status === 401) {
                handleUnauthorized();
                return;
            }

            if (response.ok) fetchTodos(currentPage);
            else alert("Could not delete todo.");
        }

        async function updateTodo(id) {
            const token = getToken();
            const title = document.getElementById(`title-${id}`).value.trim();
            const due_by = document.getElementById(`due-${id}`).value;
            const completed = document.getElementById(`completed-${id}`).checked;

            const response = await fetch(`/todos/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ id, title, due_by, completed })
            });

            if (response.status === 401) {
                handleUnauthorized();
                return;
            }

            if (!response.ok) alert("Could not update todo.");
            else fetchTodos(currentPage);
        }

        document.getElementById("todo-form").addEventListener("submit", async e => {
            e.preventDefault();
            const token = getToken();
            if (!token) {
                window.location.href = "/login-page";
                return;
            }

            const title = document.getElementById("todo-input").value.trim();
            const due_by = document.getElementById("todo-due").value;
            if (!title || !due_by) return;

            const response = await fetch("/todos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ title, due_by })
            });

            if (response.status === 401) {
                handleUnauthorized();
                return;
            }

            if (response.ok) {
                document.getElementById("todo-input").value = "";
                document.getElementById("todo-due").value = "";
                fetchTodos(currentPage);
            } else alert("Could not add todo.");
        });

        document.getElementById("next").addEventListener("click", () => {
            currentPage++;
            fetchTodos(currentPage);
        });

        document.getElementById("prev").addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                fetchTodos(currentPage);
            }
        });

        fetchTodos();
    </script>
</body>
</html>
